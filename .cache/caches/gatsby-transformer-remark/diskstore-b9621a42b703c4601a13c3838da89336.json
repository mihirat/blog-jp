{"expireTime":9007200845569391000,"key":"transformer-remark-markdown-ast-61a9c0b23db0b5a1a20919cdc5a17473-gatsby-plugin-sharpgatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-emojis-","val":{"type":"root","children":[{"type":"html","value":"<!-- # \n\t\t\t\tポチポチ手動で作成したAWSの既存リソースをTerraformに取り込むスクリプト with terraforming\t\t -->","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":3,"column":70,"offset":78},"indent":[1]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"TL; DR","position":{"start":{"line":5,"column":4,"offset":83},"end":{"line":5,"column":10,"offset":89},"indent":[]}}],"position":{"start":{"line":5,"column":1,"offset":80},"end":{"line":5,"column":10,"offset":89},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"手動で作ってしまったAWSのリソースをTerraformに取り込むスクリプトを書きました","position":{"start":{"line":7,"column":3,"offset":93},"end":{"line":7,"column":47,"offset":137},"indent":[]}}],"position":{"start":{"line":7,"column":3,"offset":93},"end":{"line":7,"column":47,"offset":137},"indent":[]}}],"position":{"start":{"line":7,"column":1,"offset":91},"end":{"line":7,"column":47,"offset":137},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"とはいえterraformingの対応範囲が広くないので、妥協は必要","position":{"start":{"line":8,"column":3,"offset":140},"end":{"line":8,"column":37,"offset":174},"indent":[]}}],"position":{"start":{"line":8,"column":3,"offset":140},"end":{"line":8,"column":37,"offset":174},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":138},"end":{"line":8,"column":37,"offset":174},"indent":[]}}],"position":{"start":{"line":7,"column":1,"offset":91},"end":{"line":8,"column":37,"offset":174},"indent":[1]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"背景","position":{"start":{"line":10,"column":4,"offset":179},"end":{"line":10,"column":6,"offset":181},"indent":[]}}],"position":{"start":{"line":10,"column":1,"offset":176},"end":{"line":10,"column":6,"offset":181},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"「まずは最低限の設定だけ手動で作ってしまおう！」とAWSを使い始めて、\n途中から管理が辛くなってきたのでTerraform化したい！と思うものの、\nすでに作ってしまったリソースをどうコード化するか問題、ありますよね（やりました","position":{"start":{"line":12,"column":1,"offset":183},"end":{"line":14,"column":40,"offset":296},"indent":[1,1]}}],"position":{"start":{"line":12,"column":1,"offset":183},"end":{"line":14,"column":40,"offset":296},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"このリソースだけはTerraform化されてないんですよーとなると、\n作業の引き継ぎなどもなかなか難しく、負債がどんどん積まれていきます。","position":{"start":{"line":16,"column":1,"offset":298},"end":{"line":17,"column":35,"offset":367},"indent":[1]}}],"position":{"start":{"line":16,"column":1,"offset":298},"end":{"line":17,"column":35,"offset":367},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"Terraformに既存リソースを記述する方法は","position":{"start":{"line":19,"column":1,"offset":369},"end":{"line":19,"column":25,"offset":393},"indent":[]}}],"position":{"start":{"line":19,"column":1,"offset":369},"end":{"line":19,"column":25,"offset":393},"indent":[]}},{"type":"heading","depth":5,"children":[{"type":"text","value":"方法1","position":{"start":{"line":21,"column":7,"offset":401},"end":{"line":21,"column":10,"offset":404},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":21,"column":10,"offset":404},"end":{"line":21,"column":12,"offset":406},"indent":[]}},{"type":"text","value":" 既存のリソースのv2をTerraformで新規に作成し、タイミングを見て移行していく","position":{"start":{"line":21,"column":12,"offset":406},"end":{"line":21,"column":55,"offset":449},"indent":[]}}],"position":{"start":{"line":21,"column":1,"offset":395},"end":{"line":21,"column":55,"offset":449},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Pros: Terraform側はめっちゃきれいに書ける","position":{"start":{"line":23,"column":3,"offset":453},"end":{"line":23,"column":31,"offset":481},"indent":[]}}],"position":{"start":{"line":23,"column":3,"offset":453},"end":{"line":23,"column":31,"offset":481},"indent":[]}}],"position":{"start":{"line":23,"column":1,"offset":451},"end":{"line":23,"column":31,"offset":481},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Cons: ダウンタイムなしでやろうと思うと長期化必死、移行作業もなかなかハード","position":{"start":{"line":24,"column":3,"offset":484},"end":{"line":24,"column":43,"offset":524},"indent":[]}}],"position":{"start":{"line":24,"column":3,"offset":484},"end":{"line":24,"column":43,"offset":524},"indent":[]}}],"position":{"start":{"line":24,"column":1,"offset":482},"end":{"line":24,"column":43,"offset":524},"indent":[]}}],"position":{"start":{"line":23,"column":1,"offset":451},"end":{"line":24,"column":43,"offset":524},"indent":[1]}},{"type":"heading","depth":5,"children":[{"type":"text","value":"方法2","position":{"start":{"line":26,"column":7,"offset":532},"end":{"line":26,"column":10,"offset":535},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":26,"column":10,"offset":535},"end":{"line":26,"column":12,"offset":537},"indent":[]}},{"type":"text","value":" 既存のリソースのコード化を諦め、data resourceなどでTerraform側に取り込んでいく","position":{"start":{"line":26,"column":12,"offset":537},"end":{"line":26,"column":63,"offset":588},"indent":[]}}],"position":{"start":{"line":26,"column":1,"offset":526},"end":{"line":26,"column":63,"offset":588},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Pros: 1と3の折衷案","position":{"start":{"line":28,"column":3,"offset":592},"end":{"line":28,"column":16,"offset":605},"indent":[]}}],"position":{"start":{"line":28,"column":3,"offset":592},"end":{"line":28,"column":16,"offset":605},"indent":[]}}],"position":{"start":{"line":28,"column":1,"offset":590},"end":{"line":28,"column":16,"offset":605},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Cons: コード化はできてないので、既存リソースの状態は管理できない","position":{"start":{"line":29,"column":3,"offset":608},"end":{"line":29,"column":38,"offset":643},"indent":[]}}],"position":{"start":{"line":29,"column":3,"offset":608},"end":{"line":29,"column":38,"offset":643},"indent":[]}}],"position":{"start":{"line":29,"column":1,"offset":606},"end":{"line":29,"column":38,"offset":643},"indent":[]}}],"position":{"start":{"line":28,"column":1,"offset":590},"end":{"line":29,"column":38,"offset":643},"indent":[1]}},{"type":"heading","depth":5,"children":[{"type":"text","value":"方法3","position":{"start":{"line":31,"column":7,"offset":651},"end":{"line":31,"column":10,"offset":654},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":31,"column":10,"offset":654},"end":{"line":31,"column":12,"offset":656},"indent":[]}},{"type":"text","value":" 既存リソースをそのままTerraformに取り込む","position":{"start":{"line":31,"column":12,"offset":656},"end":{"line":31,"column":38,"offset":682},"indent":[]}}],"position":{"start":{"line":31,"column":1,"offset":645},"end":{"line":31,"column":38,"offset":682},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Pros: 理想的","position":{"start":{"line":33,"column":3,"offset":686},"end":{"line":33,"column":12,"offset":695},"indent":[]}}],"position":{"start":{"line":33,"column":3,"offset":686},"end":{"line":33,"column":12,"offset":695},"indent":[]}}],"position":{"start":{"line":33,"column":1,"offset":684},"end":{"line":33,"column":12,"offset":695},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Cons: Terraformのimportが貧弱でつらい（後述）","position":{"start":{"line":34,"column":3,"offset":698},"end":{"line":34,"column":36,"offset":731},"indent":[]}}],"position":{"start":{"line":34,"column":3,"offset":698},"end":{"line":34,"column":36,"offset":731},"indent":[]}}],"position":{"start":{"line":34,"column":1,"offset":696},"end":{"line":34,"column":36,"offset":731},"indent":[]}}],"position":{"start":{"line":33,"column":1,"offset":684},"end":{"line":34,"column":36,"offset":731},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"なのかなと思います。以下、3を頑張っていきます。","position":{"start":{"line":36,"column":1,"offset":733},"end":{"line":36,"column":25,"offset":757},"indent":[]}}],"position":{"start":{"line":36,"column":1,"offset":733},"end":{"line":36,"column":25,"offset":757},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"terraform importを使う","position":{"start":{"line":38,"column":5,"offset":763},"end":{"line":38,"column":24,"offset":782},"indent":[]}}],"position":{"start":{"line":38,"column":1,"offset":759},"end":{"line":38,"column":24,"offset":782},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"公式でも3を行うための ","position":{"start":{"line":40,"column":1,"offset":784},"end":{"line":40,"column":13,"offset":796},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">terraform import</code>","position":{"start":{"line":40,"column":13,"offset":796},"end":{"line":40,"column":31,"offset":814},"indent":[]}},{"type":"text","value":" という機能がありますが、","position":{"start":{"line":40,"column":31,"offset":814},"end":{"line":40,"column":44,"offset":827},"indent":[]}}],"position":{"start":{"line":40,"column":1,"offset":784},"end":{"line":40,"column":44,"offset":827},"indent":[]}},{"type":"list","ordered":true,"start":1,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":42,"column":4,"offset":832},"end":{"line":42,"column":9,"offset":837},"indent":[]}},{"type":"text","value":" にリソース名だけ付与した、中身が空のリソースを作成","position":{"start":{"line":42,"column":9,"offset":837},"end":{"line":42,"column":35,"offset":863},"indent":[]}}],"position":{"start":{"line":42,"column":4,"offset":832},"end":{"line":42,"column":35,"offset":863},"indent":[]}}],"position":{"start":{"line":42,"column":1,"offset":829},"end":{"line":42,"column":35,"offset":863},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">terraform import</code>","position":{"start":{"line":43,"column":4,"offset":867},"end":{"line":43,"column":22,"offset":885},"indent":[]}},{"type":"text","value":" する ( ","position":{"start":{"line":43,"column":22,"offset":885},"end":{"line":43,"column":28,"offset":891},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":43,"column":28,"offset":891},"end":{"line":43,"column":38,"offset":901},"indent":[]}},{"type":"text","value":" のみ更新される)","position":{"start":{"line":43,"column":38,"offset":901},"end":{"line":43,"column":47,"offset":910},"indent":[]}}],"position":{"start":{"line":43,"column":4,"offset":867},"end":{"line":43,"column":47,"offset":910},"indent":[]}}],"position":{"start":{"line":43,"column":1,"offset":864},"end":{"line":43,"column":47,"offset":910},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"更新された ","position":{"start":{"line":44,"column":4,"offset":914},"end":{"line":44,"column":10,"offset":920},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":44,"column":10,"offset":920},"end":{"line":44,"column":20,"offset":930},"indent":[]}},{"type":"text","value":" にマッチするように.tfファイルの中身を手書きで埋める","position":{"start":{"line":44,"column":20,"offset":930},"end":{"line":44,"column":48,"offset":958},"indent":[]}}],"position":{"start":{"line":44,"column":4,"offset":914},"end":{"line":44,"column":48,"offset":958},"indent":[]}}],"position":{"start":{"line":44,"column":1,"offset":911},"end":{"line":44,"column":48,"offset":958},"indent":[]}}],"position":{"start":{"line":42,"column":1,"offset":829},"end":{"line":44,"column":48,"offset":958},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"という、なかなかに辛い作業です。\nこちらが詳しいです ","position":{"start":{"line":46,"column":1,"offset":960},"end":{"line":47,"column":11,"offset":987},"indent":[1]}},{"type":"link","title":null,"url":"https://blog.mosuke.tech/entry/2018/06/20/terraform_import/","children":[{"type":"text","value":"Terraformのimportの使い方と注意ポイント","position":{"start":{"line":47,"column":12,"offset":988},"end":{"line":47,"column":39,"offset":1015},"indent":[]}}],"position":{"start":{"line":47,"column":11,"offset":987},"end":{"line":47,"column":101,"offset":1077},"indent":[]}}],"position":{"start":{"line":46,"column":1,"offset":960},"end":{"line":47,"column":101,"offset":1077},"indent":[1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"terraformingを使う","position":{"start":{"line":49,"column":5,"offset":1083},"end":{"line":49,"column":20,"offset":1098},"indent":[]}}],"position":{"start":{"line":49,"column":1,"offset":1079},"end":{"line":49,"column":20,"offset":1098},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"もっとスマートにできないか、と今回参考にしたのはこちら。\n","position":{"start":{"line":51,"column":1,"offset":1100},"end":{"line":52,"column":1,"offset":1129},"indent":[1]}},{"type":"link","title":null,"url":"http://tech.grooves.com/entry/2018/01/22/091959","children":[{"type":"text","value":"Forkwell のインフラをコード化するためにやったこと","position":{"start":{"line":52,"column":2,"offset":1130},"end":{"line":52,"column":31,"offset":1159},"indent":[]}}],"position":{"start":{"line":52,"column":1,"offset":1129},"end":{"line":52,"column":81,"offset":1209},"indent":[]}}],"position":{"start":{"line":51,"column":1,"offset":1100},"end":{"line":52,"column":81,"offset":1209},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"terraformingとは、個人で開発されている、Ruby製のコマンドラインツールです。\nインストールなどはリポジトリを御覧ください。\n","position":{"start":{"line":54,"column":1,"offset":1211},"end":{"line":56,"column":1,"offset":1280},"indent":[1,1]}},{"type":"link","title":null,"url":"https://github.com/dtan4/terraforming","children":[{"type":"text","value":"terraforming","position":{"start":{"line":56,"column":2,"offset":1281},"end":{"line":56,"column":14,"offset":1293},"indent":[]}}],"position":{"start":{"line":56,"column":1,"offset":1280},"end":{"line":56,"column":54,"offset":1333},"indent":[]}}],"position":{"start":{"line":54,"column":1,"offset":1211},"end":{"line":56,"column":54,"offset":1333},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"こちらは本家と違い、既存リソースを自動的に.tfファイルへ書き出してくれて、さらにそれを.tfstateにマージする機能もあります。\nステキです。これを使って、環境を破壊しないように注意しながら自動的に既存リソースをマージしていきます。","position":{"start":{"line":58,"column":1,"offset":1335},"end":{"line":59,"column":52,"offset":1453},"indent":[1]}}],"position":{"start":{"line":58,"column":1,"offset":1335},"end":{"line":59,"column":52,"offset":1453},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"\b作業の順番としては、","position":{"start":{"line":61,"column":1,"offset":1455},"end":{"line":61,"column":12,"offset":1466},"indent":[]}}],"position":{"start":{"line":61,"column":1,"offset":1455},"end":{"line":61,"column":12,"offset":1466},"indent":[]}},{"type":"list","ordered":true,"start":1,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"リモートにある ","position":{"start":{"line":63,"column":4,"offset":1471},"end":{"line":63,"column":12,"offset":1479},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":63,"column":12,"offset":1479},"end":{"line":63,"column":22,"offset":1489},"indent":[]}},{"type":"text","value":" をローカルにコピーし、さらにバックアップをとる","position":{"start":{"line":63,"column":22,"offset":1489},"end":{"line":63,"column":46,"offset":1513},"indent":[]}}],"position":{"start":{"line":63,"column":4,"offset":1471},"end":{"line":63,"column":46,"offset":1513},"indent":[]}}],"position":{"start":{"line":63,"column":1,"offset":1468},"end":{"line":63,"column":46,"offset":1513},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"既存リソースを ","position":{"start":{"line":64,"column":4,"offset":1517},"end":{"line":64,"column":12,"offset":1525},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":64,"column":12,"offset":1525},"end":{"line":64,"column":17,"offset":1530},"indent":[]}},{"type":"text","value":" に書き出す","position":{"start":{"line":64,"column":17,"offset":1530},"end":{"line":64,"column":23,"offset":1536},"indent":[]}}],"position":{"start":{"line":64,"column":4,"offset":1517},"end":{"line":64,"column":23,"offset":1536},"indent":[]}}],"position":{"start":{"line":64,"column":1,"offset":1514},"end":{"line":64,"column":23,"offset":1536},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":65,"column":4,"offset":1540},"end":{"line":65,"column":9,"offset":1545},"indent":[]}},{"type":"text","value":" に書き出した中身をローカルの ","position":{"start":{"line":65,"column":9,"offset":1545},"end":{"line":65,"column":25,"offset":1561},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":65,"column":25,"offset":1561},"end":{"line":65,"column":35,"offset":1571},"indent":[]}},{"type":"text","value":" にマージする","position":{"start":{"line":65,"column":35,"offset":1571},"end":{"line":65,"column":42,"offset":1578},"indent":[]}}],"position":{"start":{"line":65,"column":4,"offset":1540},"end":{"line":65,"column":42,"offset":1578},"indent":[]}}],"position":{"start":{"line":65,"column":1,"offset":1537},"end":{"line":65,"column":42,"offset":1578},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"\bローカルにある ","position":{"start":{"line":66,"column":4,"offset":1582},"end":{"line":66,"column":13,"offset":1591},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":66,"column":13,"offset":1591},"end":{"line":66,"column":18,"offset":1596},"indent":[]}},{"type":"text","value":" を使って、ローカルの ","position":{"start":{"line":66,"column":18,"offset":1596},"end":{"line":66,"column":30,"offset":1608},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":66,"column":30,"offset":1608},"end":{"line":66,"column":40,"offset":1618},"indent":[]}},{"type":"text","value":" に対して ","position":{"start":{"line":66,"column":40,"offset":1618},"end":{"line":66,"column":46,"offset":1624},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">terraform plan</code>","position":{"start":{"line":66,"column":46,"offset":1624},"end":{"line":66,"column":62,"offset":1640},"indent":[]}},{"type":"text","value":" を行い、リソースの追加や削除といった変更が出ないことを確認する ( ","position":{"start":{"line":66,"column":62,"offset":1640},"end":{"line":66,"column":97,"offset":1675},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":66,"column":97,"offset":1675},"end":{"line":66,"column":102,"offset":1680},"indent":[]}},{"type":"text","value":" の状態と ","position":{"start":{"line":66,"column":102,"offset":1680},"end":{"line":66,"column":108,"offset":1686},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":66,"column":108,"offset":1686},"end":{"line":66,"column":118,"offset":1696},"indent":[]}},{"type":"text","value":" に差分がないことを確認する)","position":{"start":{"line":66,"column":118,"offset":1696},"end":{"line":66,"column":133,"offset":1711},"indent":[]}}],"position":{"start":{"line":66,"column":4,"offset":1582},"end":{"line":66,"column":133,"offset":1711},"indent":[]}}],"position":{"start":{"line":66,"column":1,"offset":1579},"end":{"line":66,"column":133,"offset":1711},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"問題なければ、ローカルにコピーした ","position":{"start":{"line":67,"column":4,"offset":1715},"end":{"line":67,"column":22,"offset":1733},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":67,"column":22,"offset":1733},"end":{"line":67,"column":32,"offset":1743},"indent":[]}},{"type":"text","value":" をリモートに上書き","position":{"start":{"line":67,"column":32,"offset":1743},"end":{"line":67,"column":42,"offset":1753},"indent":[]}}],"position":{"start":{"line":67,"column":4,"offset":1715},"end":{"line":67,"column":42,"offset":1753},"indent":[]}}],"position":{"start":{"line":67,"column":1,"offset":1712},"end":{"line":67,"column":42,"offset":1753},"indent":[]}}],"position":{"start":{"line":63,"column":1,"offset":1468},"end":{"line":67,"column":42,"offset":1753},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"となります。これをシェルで雑に書くとこんな処理になります。","position":{"start":{"line":69,"column":1,"offset":1755},"end":{"line":69,"column":30,"offset":1784},"indent":[]}}],"position":{"start":{"line":69,"column":1,"offset":1755},"end":{"line":69,"column":30,"offset":1784},"indent":[]}},{"type":"html","value":"<pre class=\"lang:shell decode:true\">\n#!/usr/bin/env bash\n# terraforming_merge.sh\n\nset -o nounset\nset -o errexit\n\nterraforming_resource_key=$1\noutput_filename=$2.tf\n\n# リモートから .tfstateをとってくる\naws s3 cp s3://my-terraform-state/aws-terraform.tfstate ./bin/\n\n# バックアップとっておく\ncp ./bin/aws-terraform.tfstate ./bin/aws-terraform.tfstate.bak\n\n# .tf に書き出し\nterraforming $terraforming_resource_key > $output_filename\n\n# tfstateにマージ\nterraforming $terraforming_resource_key --tfstate --merge ./bin/aws-terraform.tfstate --overwrite\n\n# 差分がでてないか確認。差分出たときのコメントをgrepしてるだけなので、仕様変更に要注意\n./bin/terraform_plan.sh > result.log\nis_changed=$(echo $(cat result.log | grep 'to add'))\n\nif [ -n \"$is_changed\" ]; then\n  # 差分が出てたら、result.logを見て修正する\n  echo \"diff found. Check your changes.\"\nelse\n  # 差分がなければimport成功\n  echo \"ALL GREEN. .bak is deleted and overwrite merged tfstate to s3.\"\n  rm ./bin/aws-terraform.tfstate.bak\n  rm result.log\n  # upload tfstate\n  aws s3 cp ./bin/aws-terraform.tfstate s3://my-terraform-state/aws-terraform.tfstate\n  rm ./bin/aws-terraform.tfstate\nfi\n</pre>","position":{"start":{"line":71,"column":1,"offset":1786},"end":{"line":109,"column":7,"offset":2838},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"呼び出すときは\n","position":{"start":{"line":111,"column":1,"offset":2840},"end":{"line":112,"column":1,"offset":2848},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ terraforming_merge.sh vpc my-vpc</code>","position":{"start":{"line":112,"column":1,"offset":2848},"end":{"line":112,"column":37,"offset":2884},"indent":[]}},{"type":"text","value":"\nみたいに使います。\nこのスクリプトで、リソースの種別ごとにまとめてimportできるようになりました。\n(もしこれを使うようでしたら、一応一行ずつ実行して問題ないか確認してくださいね！)","position":{"start":{"line":112,"column":37,"offset":2884},"end":{"line":115,"column":42,"offset":2978},"indent":[1,1,1]}}],"position":{"start":{"line":111,"column":1,"offset":2840},"end":{"line":115,"column":42,"offset":2978},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"完！と行きたいのですが、一つ問題が。\nterraformingでimportできるリソースの種類が非常に限られたものだけになっています。\n（本家の開発が早すぎるのでやむを得ないと思いますが。）","position":{"start":{"line":117,"column":1,"offset":2980},"end":{"line":119,"column":28,"offset":3076},"indent":[1,1]}}],"position":{"start":{"line":117,"column":1,"offset":2980},"end":{"line":119,"column":28,"offset":3076},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"とはいえ、\nVPC、Route53、Security Group、RDS、ELBなどの\nコアなものについてはカバーされていますので、ある程度はこれでimportできる気がします。","position":{"start":{"line":121,"column":1,"offset":3078},"end":{"line":123,"column":46,"offset":3167},"indent":[1,1]}}],"position":{"start":{"line":121,"column":1,"offset":3078},"end":{"line":123,"column":46,"offset":3167},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"これでimportできないものについては、\n最初に挙げた1や2の方法で少しずつTerraform化していくことになるのかなと。","position":{"start":{"line":125,"column":1,"offset":3169},"end":{"line":126,"column":42,"offset":3232},"indent":[1]}}],"position":{"start":{"line":125,"column":1,"offset":3169},"end":{"line":126,"column":42,"offset":3232},"indent":[1]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":126,"column":42,"offset":3232}}}}