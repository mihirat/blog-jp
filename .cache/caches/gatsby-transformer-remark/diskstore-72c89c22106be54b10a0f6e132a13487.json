{"expireTime":9007200845574950000,"key":"transformer-remark-markdown-ast-888f6a5bad34a49b7aec0a1751eb050e-gatsby-plugin-sharpgatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-emojis-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"Istioで複数アプリケーションのホスティングするのに詰まったので、記事にしておきます。\nIstio自体の導入については","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":3,"column":16,"offset":61},"indent":[1]}},{"type":"link","title":null,"url":"http://techeten.xyz/10305","children":[{"type":"text","value":"前回の記事","position":{"start":{"line":3,"column":17,"offset":62},"end":{"line":3,"column":22,"offset":67},"indent":[]}}],"position":{"start":{"line":3,"column":16,"offset":61},"end":{"line":3,"column":50,"offset":95},"indent":[]}},{"type":"text","value":"などをご参考ください。","position":{"start":{"line":3,"column":50,"offset":95},"end":{"line":3,"column":61,"offset":106},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":3,"column":61,"offset":106},"indent":[1]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"問題","position":{"start":{"line":5,"column":4,"offset":111},"end":{"line":5,"column":6,"offset":113},"indent":[]}}],"position":{"start":{"line":5,"column":1,"offset":108},"end":{"line":5,"column":6,"offset":113},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"前回の記事で導入したのと同じように","position":{"start":{"line":7,"column":1,"offset":115},"end":{"line":7,"column":18,"offset":132},"indent":[]}}],"position":{"start":{"line":7,"column":1,"offset":115},"end":{"line":7,"column":18,"offset":132},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"別のNamespaceを新たに作成し、Istio injectionを有効化","position":{"start":{"line":9,"column":3,"offset":136},"end":{"line":9,"column":41,"offset":174},"indent":[]}}],"position":{"start":{"line":9,"column":3,"offset":136},"end":{"line":9,"column":41,"offset":174},"indent":[]}}],"position":{"start":{"line":9,"column":1,"offset":134},"end":{"line":9,"column":41,"offset":174},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"そこに新しいFQDN用のGatewayとVirtualServiceを作成","position":{"start":{"line":10,"column":3,"offset":177},"end":{"line":10,"column":40,"offset":214},"indent":[]}}],"position":{"start":{"line":10,"column":3,"offset":177},"end":{"line":10,"column":40,"offset":214},"indent":[]}}],"position":{"start":{"line":10,"column":1,"offset":175},"end":{"line":10,"column":40,"offset":214},"indent":[]}}],"position":{"start":{"line":9,"column":1,"offset":134},"end":{"line":10,"column":40,"offset":214},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"して、新しいFQDN用のリソースをIstioで受けられるようにしたかったのですが、どうしてもできないのです。","position":{"start":{"line":12,"column":1,"offset":216},"end":{"line":12,"column":55,"offset":270},"indent":[]}}],"position":{"start":{"line":12,"column":1,"offset":216},"end":{"line":12,"column":55,"offset":270},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"いろいろ試して実験してみたところ、","position":{"start":{"line":14,"column":1,"offset":272},"end":{"line":14,"column":18,"offset":289},"indent":[]}}],"position":{"start":{"line":14,"column":1,"offset":272},"end":{"line":14,"column":18,"offset":289},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"VirtualServiceは、自分が所属するNamespace内に存在するGatewayにしか紐づけできない","position":{"start":{"line":16,"column":3,"offset":293},"end":{"line":16,"column":58,"offset":348},"indent":[]}}],"position":{"start":{"line":16,"column":3,"offset":293},"end":{"line":16,"column":58,"offset":348},"indent":[]}}],"position":{"start":{"line":16,"column":1,"offset":291},"end":{"line":16,"column":58,"offset":348},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"複数のGatewayを複数のNamespaceにデプロイすると、最初にデプロイしたGatewayに記載のあるFQDNしか名前解決ができない","position":{"start":{"line":17,"column":3,"offset":351},"end":{"line":17,"column":72,"offset":420},"indent":[]}}],"position":{"start":{"line":17,"column":3,"offset":351},"end":{"line":17,"column":72,"offset":420},"indent":[]}}],"position":{"start":{"line":17,"column":1,"offset":349},"end":{"line":17,"column":72,"offset":420},"indent":[]}}],"position":{"start":{"line":16,"column":1,"offset":291},"end":{"line":17,"column":72,"offset":420},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"ということがわかりました。","position":{"start":{"line":19,"column":1,"offset":422},"end":{"line":19,"column":14,"offset":435},"indent":[]}}],"position":{"start":{"line":19,"column":1,"offset":422},"end":{"line":19,"column":14,"offset":435},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"異なるアプリケーションは別のNamespaceで管理したかったため、全部を一つのNamespaceで管理することは避けたく、原因を調査しました。\n(全て同じNamespace内にデプロイする方法は","position":{"start":{"line":21,"column":1,"offset":437},"end":{"line":22,"column":26,"offset":535},"indent":[1]}},{"type":"link","title":null,"url":"https://preliminary.istio.io/docs/tasks/traffic-management/secure-ingress/#configure-a-tls-ingress-gateway-for-multiple-hosts","children":[{"type":"text","value":"公式のドキュメントに記載があります","position":{"start":{"line":22,"column":27,"offset":536},"end":{"line":22,"column":44,"offset":553},"indent":[]}}],"position":{"start":{"line":22,"column":26,"offset":535},"end":{"line":22,"column":172,"offset":681},"indent":[]}},{"type":"text","value":")","position":{"start":{"line":22,"column":172,"offset":681},"end":{"line":22,"column":173,"offset":682},"indent":[]}}],"position":{"start":{"line":21,"column":1,"offset":437},"end":{"line":22,"column":173,"offset":682},"indent":[1]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"原因: GatewayリソースはNamespace間で共通","position":{"start":{"line":24,"column":4,"offset":687},"end":{"line":24,"column":33,"offset":716},"indent":[]}}],"position":{"start":{"line":24,"column":1,"offset":684},"end":{"line":24,"column":33,"offset":716},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"今回の問題の調査として大いに参考になったのが","position":{"start":{"line":26,"column":1,"offset":718},"end":{"line":26,"column":23,"offset":740},"indent":[]}},{"type":"link","title":null,"url":"https://groups.google.com/forum/#!topic/istio-users/QFUcc4AV4Jk","children":[{"type":"text","value":"こちらのGoogle groupのディスカッション","position":{"start":{"line":26,"column":24,"offset":741},"end":{"line":26,"column":49,"offset":766},"indent":[]}}],"position":{"start":{"line":26,"column":23,"offset":740},"end":{"line":26,"column":115,"offset":832},"indent":[]}},{"type":"text","value":"。","position":{"start":{"line":26,"column":115,"offset":832},"end":{"line":26,"column":116,"offset":833},"indent":[]}}],"position":{"start":{"line":26,"column":1,"offset":718},"end":{"line":26,"column":116,"offset":833},"indent":[]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"text","value":"gateways are not namespaced -they are common across all namespaces.","position":{"start":{"line":28,"column":3,"offset":837},"end":{"line":28,"column":70,"offset":904},"indent":[]}}],"position":{"start":{"line":28,"column":3,"offset":837},"end":{"line":28,"column":70,"offset":904},"indent":[]}}],"position":{"start":{"line":28,"column":1,"offset":835},"end":{"line":28,"column":70,"offset":904},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"これが全てでした。Gatewayは複数デプロイすると互いに干渉するようです。\n(","position":{"start":{"line":30,"column":1,"offset":906},"end":{"line":31,"column":2,"offset":946},"indent":[1]}},{"type":"link","title":null,"url":"https://github.com/istio/istio/issues/6046","children":[{"type":"text","value":"Issue","position":{"start":{"line":31,"column":3,"offset":947},"end":{"line":31,"column":8,"offset":952},"indent":[]}}],"position":{"start":{"line":31,"column":2,"offset":946},"end":{"line":31,"column":53,"offset":997},"indent":[]}},{"type":"text","value":"も立っていますが、仕様かバグかよくわからない)","position":{"start":{"line":31,"column":53,"offset":997},"end":{"line":31,"column":76,"offset":1020},"indent":[]}}],"position":{"start":{"line":30,"column":1,"offset":906},"end":{"line":31,"column":76,"offset":1020},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"じゃあNamespace分割するにはどうしたらいいんだ…？と思ったのですが、kube-dnsを使えば解決できます。\nk8s内のリソースの名前解決は","position":{"start":{"line":33,"column":1,"offset":1022},"end":{"line":34,"column":16,"offset":1095},"indent":[1]}}],"position":{"start":{"line":33,"column":1,"offset":1022},"end":{"line":34,"column":16,"offset":1095},"indent":[1]}},{"type":"html","value":"<pre class=\"lang:yaml decode:true \"><service-name>.<cluster-namespace>.svc.cluster.local</cluster-namespace></service-name></pre>","position":{"start":{"line":36,"column":1,"offset":1097},"end":{"line":36,"column":130,"offset":1226},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"が使えるので、これをVirtualService > destination > host に記載すれば、Namespaceをまたいでサービスディスカバリが可能になります。","position":{"start":{"line":38,"column":1,"offset":1228},"end":{"line":38,"column":87,"offset":1314},"indent":[]}}],"position":{"start":{"line":38,"column":1,"offset":1228},"end":{"line":38,"column":87,"offset":1314},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"コードでは下記の感じです。","position":{"start":{"line":40,"column":1,"offset":1316},"end":{"line":40,"column":14,"offset":1329},"indent":[]}}],"position":{"start":{"line":40,"column":1,"offset":1316},"end":{"line":40,"column":14,"offset":1329},"indent":[]}},{"type":"html","value":"<pre class=\"lang:yaml decode:true \">apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n name: common-istio-gateway\nspec:\n selector:\n   istio: ingressgateway # use istio default controller\n servers:\n - port: #マルチドメインの場合は、certificateなどを別名で(another-tls.crtなど)Secretとしてデプロイし、この項目を増やしていく\n     number: 443\n     name: https\n     protocol: HTTPS\n   tls:\n     mode: SIMPLE\n     serverCertificate: /etc/istio/ingressgateway-certs/tls.crt\n     privateKey: /etc/istio/ingressgateway-certs/tls.key\n   hosts:\n   - my-app1.example.com\n   - my-app2.example.com\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n name: my-app1\nspec:\n hosts:\n - my-app1.example.com\n gateways:\n - common-istio-gateway\n http:\n - route:\n   - destination:\n       host:\n         my-service1.my-app1.svc.cluster.local\n       port:\n         number: 80\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n name: my-app2\nspec:\n hosts:\n - my-app2.example.com\n gateways:\n - common-istio-gateway\n http:\n - route:\n   - destination:\n       host:\n         my-service2.my-app2.svc.cluster.local\n       port:\n         number: 80\n</pre>","position":{"start":{"line":42,"column":1,"offset":1331},"end":{"line":95,"column":7,"offset":2478},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Namespaceをまたいで共通のリソースなので、全てdefault namespaceにデプロイすることにします。\nこれで無事マルチホスティングができました。","position":{"start":{"line":97,"column":1,"offset":2480},"end":{"line":98,"column":22,"offset":2560},"indent":[1]}}],"position":{"start":{"line":97,"column":1,"offset":2480},"end":{"line":98,"column":22,"offset":2560},"indent":[1]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"補足","position":{"start":{"line":100,"column":4,"offset":2565},"end":{"line":100,"column":6,"offset":2567},"indent":[]}}],"position":{"start":{"line":100,"column":1,"offset":2562},"end":{"line":100,"column":6,"offset":2567},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"さきほどのディスカッションにて","position":{"start":{"line":102,"column":1,"offset":2569},"end":{"line":102,"column":16,"offset":2584},"indent":[]}}],"position":{"start":{"line":102,"column":1,"offset":2569},"end":{"line":102,"column":16,"offset":2584},"indent":[]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"text","value":"Also, I would suggest launching different gateway controllers for each gateway spec, instead of adding multiple gateways to the same controller (istio: ingressgateway).","position":{"start":{"line":104,"column":3,"offset":2588},"end":{"line":104,"column":171,"offset":2756},"indent":[]}}],"position":{"start":{"line":104,"column":3,"offset":2588},"end":{"line":104,"column":171,"offset":2756},"indent":[]}}],"position":{"start":{"line":104,"column":1,"offset":2586},"end":{"line":104,"column":171,"offset":2756},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"ということが述べられており、Controllerを複数作成することで複数Gatewayも可能のようですが、まだ試していません。","position":{"start":{"line":106,"column":1,"offset":2758},"end":{"line":106,"column":64,"offset":2821},"indent":[]}}],"position":{"start":{"line":106,"column":1,"offset":2758},"end":{"line":106,"column":64,"offset":2821},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":106,"column":64,"offset":2821}}}}