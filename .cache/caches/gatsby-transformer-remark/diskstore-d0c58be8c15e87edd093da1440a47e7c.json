{"expireTime":9007200845574950000,"key":"transformer-remark-markdown-ast-3f0780ac7c4ed8ea26aa8a1e171b0055-gatsby-plugin-sharpgatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-emojis-","val":{"type":"root","children":[{"type":"heading","depth":2,"children":[{"type":"text","value":"TL; DR","position":{"start":{"line":3,"column":4,"offset":5},"end":{"line":3,"column":10,"offset":11},"indent":[]}}],"position":{"start":{"line":3,"column":1,"offset":2},"end":{"line":3,"column":10,"offset":11},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"手動で作ってしまったAWSのリソースをTerraformに取り込むスクリプトを書きました","position":{"start":{"line":5,"column":3,"offset":15},"end":{"line":5,"column":47,"offset":59},"indent":[]}}],"position":{"start":{"line":5,"column":3,"offset":15},"end":{"line":5,"column":47,"offset":59},"indent":[]}}],"position":{"start":{"line":5,"column":1,"offset":13},"end":{"line":5,"column":47,"offset":59},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"とはいえterraformingの対応範囲が広くないので、妥協は必要","position":{"start":{"line":6,"column":3,"offset":62},"end":{"line":6,"column":37,"offset":96},"indent":[]}}],"position":{"start":{"line":6,"column":3,"offset":62},"end":{"line":6,"column":37,"offset":96},"indent":[]}}],"position":{"start":{"line":6,"column":1,"offset":60},"end":{"line":6,"column":37,"offset":96},"indent":[]}}],"position":{"start":{"line":5,"column":1,"offset":13},"end":{"line":6,"column":37,"offset":96},"indent":[1]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"背景","position":{"start":{"line":8,"column":4,"offset":101},"end":{"line":8,"column":6,"offset":103},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":98},"end":{"line":8,"column":6,"offset":103},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"「まずは最低限の設定だけ手動で作ってしまおう！」とAWSを使い始めて、\n途中から管理が辛くなってきたのでTerraform化したい！と思うものの、\nすでに作ってしまったリソースをどうコード化するか問題、ありますよね（やりました","position":{"start":{"line":10,"column":1,"offset":105},"end":{"line":12,"column":40,"offset":218},"indent":[1,1]}}],"position":{"start":{"line":10,"column":1,"offset":105},"end":{"line":12,"column":40,"offset":218},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"このリソースだけはTerraform化されてないんですよーとなると、\n作業の引き継ぎなどもなかなか難しく、負債がどんどん積まれていきます。","position":{"start":{"line":14,"column":1,"offset":220},"end":{"line":15,"column":35,"offset":289},"indent":[1]}}],"position":{"start":{"line":14,"column":1,"offset":220},"end":{"line":15,"column":35,"offset":289},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"Terraformに既存リソースを記述する方法は","position":{"start":{"line":17,"column":1,"offset":291},"end":{"line":17,"column":25,"offset":315},"indent":[]}}],"position":{"start":{"line":17,"column":1,"offset":291},"end":{"line":17,"column":25,"offset":315},"indent":[]}},{"type":"heading","depth":5,"children":[{"type":"text","value":"方法1","position":{"start":{"line":19,"column":7,"offset":323},"end":{"line":19,"column":10,"offset":326},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":19,"column":10,"offset":326},"end":{"line":19,"column":12,"offset":328},"indent":[]}},{"type":"text","value":" 既存のリソースのv2をTerraformで新規に作成し、タイミングを見て移行していく","position":{"start":{"line":19,"column":12,"offset":328},"end":{"line":19,"column":55,"offset":371},"indent":[]}}],"position":{"start":{"line":19,"column":1,"offset":317},"end":{"line":19,"column":55,"offset":371},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Pros: Terraform側はめっちゃきれいに書ける","position":{"start":{"line":21,"column":3,"offset":375},"end":{"line":21,"column":31,"offset":403},"indent":[]}}],"position":{"start":{"line":21,"column":3,"offset":375},"end":{"line":21,"column":31,"offset":403},"indent":[]}}],"position":{"start":{"line":21,"column":1,"offset":373},"end":{"line":21,"column":31,"offset":403},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Cons: ダウンタイムなしでやろうと思うと長期化必死、移行作業もなかなかハード","position":{"start":{"line":22,"column":3,"offset":406},"end":{"line":22,"column":43,"offset":446},"indent":[]}}],"position":{"start":{"line":22,"column":3,"offset":406},"end":{"line":22,"column":43,"offset":446},"indent":[]}}],"position":{"start":{"line":22,"column":1,"offset":404},"end":{"line":22,"column":43,"offset":446},"indent":[]}}],"position":{"start":{"line":21,"column":1,"offset":373},"end":{"line":22,"column":43,"offset":446},"indent":[1]}},{"type":"heading","depth":5,"children":[{"type":"text","value":"方法2","position":{"start":{"line":24,"column":7,"offset":454},"end":{"line":24,"column":10,"offset":457},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":24,"column":10,"offset":457},"end":{"line":24,"column":12,"offset":459},"indent":[]}},{"type":"text","value":" 既存のリソースのコード化を諦め、data resourceなどでTerraform側に取り込んでいく","position":{"start":{"line":24,"column":12,"offset":459},"end":{"line":24,"column":63,"offset":510},"indent":[]}}],"position":{"start":{"line":24,"column":1,"offset":448},"end":{"line":24,"column":63,"offset":510},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Pros: 1と3の折衷案","position":{"start":{"line":26,"column":3,"offset":514},"end":{"line":26,"column":16,"offset":527},"indent":[]}}],"position":{"start":{"line":26,"column":3,"offset":514},"end":{"line":26,"column":16,"offset":527},"indent":[]}}],"position":{"start":{"line":26,"column":1,"offset":512},"end":{"line":26,"column":16,"offset":527},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Cons: コード化はできてないので、既存リソースの状態は管理できない","position":{"start":{"line":27,"column":3,"offset":530},"end":{"line":27,"column":38,"offset":565},"indent":[]}}],"position":{"start":{"line":27,"column":3,"offset":530},"end":{"line":27,"column":38,"offset":565},"indent":[]}}],"position":{"start":{"line":27,"column":1,"offset":528},"end":{"line":27,"column":38,"offset":565},"indent":[]}}],"position":{"start":{"line":26,"column":1,"offset":512},"end":{"line":27,"column":38,"offset":565},"indent":[1]}},{"type":"heading","depth":5,"children":[{"type":"text","value":"方法3","position":{"start":{"line":29,"column":7,"offset":573},"end":{"line":29,"column":10,"offset":576},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":29,"column":10,"offset":576},"end":{"line":29,"column":12,"offset":578},"indent":[]}},{"type":"text","value":" 既存リソースをそのままTerraformに取り込む","position":{"start":{"line":29,"column":12,"offset":578},"end":{"line":29,"column":38,"offset":604},"indent":[]}}],"position":{"start":{"line":29,"column":1,"offset":567},"end":{"line":29,"column":38,"offset":604},"indent":[]}},{"type":"list","ordered":false,"start":null,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Pros: 理想的","position":{"start":{"line":31,"column":3,"offset":608},"end":{"line":31,"column":12,"offset":617},"indent":[]}}],"position":{"start":{"line":31,"column":3,"offset":608},"end":{"line":31,"column":12,"offset":617},"indent":[]}}],"position":{"start":{"line":31,"column":1,"offset":606},"end":{"line":31,"column":12,"offset":617},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Cons: Terraformのimportが貧弱でつらい（後述）","position":{"start":{"line":32,"column":3,"offset":620},"end":{"line":32,"column":36,"offset":653},"indent":[]}}],"position":{"start":{"line":32,"column":3,"offset":620},"end":{"line":32,"column":36,"offset":653},"indent":[]}}],"position":{"start":{"line":32,"column":1,"offset":618},"end":{"line":32,"column":36,"offset":653},"indent":[]}}],"position":{"start":{"line":31,"column":1,"offset":606},"end":{"line":32,"column":36,"offset":653},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"なのかなと思います。以下、3を頑張っていきます。","position":{"start":{"line":34,"column":1,"offset":655},"end":{"line":34,"column":25,"offset":679},"indent":[]}}],"position":{"start":{"line":34,"column":1,"offset":655},"end":{"line":34,"column":25,"offset":679},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"terraform importを使う","position":{"start":{"line":36,"column":5,"offset":685},"end":{"line":36,"column":24,"offset":704},"indent":[]}}],"position":{"start":{"line":36,"column":1,"offset":681},"end":{"line":36,"column":24,"offset":704},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"公式でも3を行うための ","position":{"start":{"line":38,"column":1,"offset":706},"end":{"line":38,"column":13,"offset":718},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">terraform import</code>","position":{"start":{"line":38,"column":13,"offset":718},"end":{"line":38,"column":31,"offset":736},"indent":[]}},{"type":"text","value":" という機能がありますが、","position":{"start":{"line":38,"column":31,"offset":736},"end":{"line":38,"column":44,"offset":749},"indent":[]}}],"position":{"start":{"line":38,"column":1,"offset":706},"end":{"line":38,"column":44,"offset":749},"indent":[]}},{"type":"list","ordered":true,"start":1,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":40,"column":4,"offset":754},"end":{"line":40,"column":9,"offset":759},"indent":[]}},{"type":"text","value":" にリソース名だけ付与した、中身が空のリソースを作成","position":{"start":{"line":40,"column":9,"offset":759},"end":{"line":40,"column":35,"offset":785},"indent":[]}}],"position":{"start":{"line":40,"column":4,"offset":754},"end":{"line":40,"column":35,"offset":785},"indent":[]}}],"position":{"start":{"line":40,"column":1,"offset":751},"end":{"line":40,"column":35,"offset":785},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">terraform import</code>","position":{"start":{"line":41,"column":4,"offset":789},"end":{"line":41,"column":22,"offset":807},"indent":[]}},{"type":"text","value":" する ( ","position":{"start":{"line":41,"column":22,"offset":807},"end":{"line":41,"column":28,"offset":813},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":41,"column":28,"offset":813},"end":{"line":41,"column":38,"offset":823},"indent":[]}},{"type":"text","value":" のみ更新される)","position":{"start":{"line":41,"column":38,"offset":823},"end":{"line":41,"column":47,"offset":832},"indent":[]}}],"position":{"start":{"line":41,"column":4,"offset":789},"end":{"line":41,"column":47,"offset":832},"indent":[]}}],"position":{"start":{"line":41,"column":1,"offset":786},"end":{"line":41,"column":47,"offset":832},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"更新された ","position":{"start":{"line":42,"column":4,"offset":836},"end":{"line":42,"column":10,"offset":842},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":42,"column":10,"offset":842},"end":{"line":42,"column":20,"offset":852},"indent":[]}},{"type":"text","value":" にマッチするように.tfファイルの中身を手書きで埋める","position":{"start":{"line":42,"column":20,"offset":852},"end":{"line":42,"column":48,"offset":880},"indent":[]}}],"position":{"start":{"line":42,"column":4,"offset":836},"end":{"line":42,"column":48,"offset":880},"indent":[]}}],"position":{"start":{"line":42,"column":1,"offset":833},"end":{"line":42,"column":48,"offset":880},"indent":[]}}],"position":{"start":{"line":40,"column":1,"offset":751},"end":{"line":42,"column":48,"offset":880},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"という、なかなかに辛い作業です。\nこちらが詳しいです ","position":{"start":{"line":44,"column":1,"offset":882},"end":{"line":45,"column":11,"offset":909},"indent":[1]}},{"type":"link","title":null,"url":"https://blog.mosuke.tech/entry/2018/06/20/terraform_import/","children":[{"type":"text","value":"Terraformのimportの使い方と注意ポイント","position":{"start":{"line":45,"column":12,"offset":910},"end":{"line":45,"column":39,"offset":937},"indent":[]}}],"position":{"start":{"line":45,"column":11,"offset":909},"end":{"line":45,"column":101,"offset":999},"indent":[]}}],"position":{"start":{"line":44,"column":1,"offset":882},"end":{"line":45,"column":101,"offset":999},"indent":[1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"terraformingを使う","position":{"start":{"line":47,"column":5,"offset":1005},"end":{"line":47,"column":20,"offset":1020},"indent":[]}}],"position":{"start":{"line":47,"column":1,"offset":1001},"end":{"line":47,"column":20,"offset":1020},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"もっとスマートにできないか、と今回参考にしたのはこちら。\n","position":{"start":{"line":49,"column":1,"offset":1022},"end":{"line":50,"column":1,"offset":1051},"indent":[1]}},{"type":"link","title":null,"url":"http://tech.grooves.com/entry/2018/01/22/091959","children":[{"type":"text","value":"Forkwell のインフラをコード化するためにやったこと","position":{"start":{"line":50,"column":2,"offset":1052},"end":{"line":50,"column":31,"offset":1081},"indent":[]}}],"position":{"start":{"line":50,"column":1,"offset":1051},"end":{"line":50,"column":81,"offset":1131},"indent":[]}}],"position":{"start":{"line":49,"column":1,"offset":1022},"end":{"line":50,"column":81,"offset":1131},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"terraformingとは、個人で開発されている、Ruby製のコマンドラインツールです。\nインストールなどはリポジトリを御覧ください。\n","position":{"start":{"line":52,"column":1,"offset":1133},"end":{"line":54,"column":1,"offset":1202},"indent":[1,1]}},{"type":"link","title":null,"url":"https://github.com/dtan4/terraforming","children":[{"type":"text","value":"terraforming","position":{"start":{"line":54,"column":2,"offset":1203},"end":{"line":54,"column":14,"offset":1215},"indent":[]}}],"position":{"start":{"line":54,"column":1,"offset":1202},"end":{"line":54,"column":54,"offset":1255},"indent":[]}}],"position":{"start":{"line":52,"column":1,"offset":1133},"end":{"line":54,"column":54,"offset":1255},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"こちらは本家と違い、既存リソースを自動的に.tfファイルへ書き出してくれて、さらにそれを.tfstateにマージする機能もあります。\nステキです。これを使って、環境を破壊しないように注意しながら自動的に既存リソースをマージしていきます。","position":{"start":{"line":56,"column":1,"offset":1257},"end":{"line":57,"column":52,"offset":1375},"indent":[1]}}],"position":{"start":{"line":56,"column":1,"offset":1257},"end":{"line":57,"column":52,"offset":1375},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"\b作業の順番としては、","position":{"start":{"line":59,"column":1,"offset":1377},"end":{"line":59,"column":12,"offset":1388},"indent":[]}}],"position":{"start":{"line":59,"column":1,"offset":1377},"end":{"line":59,"column":12,"offset":1388},"indent":[]}},{"type":"list","ordered":true,"start":1,"loose":false,"children":[{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"リモートにある ","position":{"start":{"line":61,"column":4,"offset":1393},"end":{"line":61,"column":12,"offset":1401},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":61,"column":12,"offset":1401},"end":{"line":61,"column":22,"offset":1411},"indent":[]}},{"type":"text","value":" をローカルにコピーし、さらにバックアップをとる","position":{"start":{"line":61,"column":22,"offset":1411},"end":{"line":61,"column":46,"offset":1435},"indent":[]}}],"position":{"start":{"line":61,"column":4,"offset":1393},"end":{"line":61,"column":46,"offset":1435},"indent":[]}}],"position":{"start":{"line":61,"column":1,"offset":1390},"end":{"line":61,"column":46,"offset":1435},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"既存リソースを ","position":{"start":{"line":62,"column":4,"offset":1439},"end":{"line":62,"column":12,"offset":1447},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":62,"column":12,"offset":1447},"end":{"line":62,"column":17,"offset":1452},"indent":[]}},{"type":"text","value":" に書き出す","position":{"start":{"line":62,"column":17,"offset":1452},"end":{"line":62,"column":23,"offset":1458},"indent":[]}}],"position":{"start":{"line":62,"column":4,"offset":1439},"end":{"line":62,"column":23,"offset":1458},"indent":[]}}],"position":{"start":{"line":62,"column":1,"offset":1436},"end":{"line":62,"column":23,"offset":1458},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":63,"column":4,"offset":1462},"end":{"line":63,"column":9,"offset":1467},"indent":[]}},{"type":"text","value":" に書き出した中身をローカルの ","position":{"start":{"line":63,"column":9,"offset":1467},"end":{"line":63,"column":25,"offset":1483},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":63,"column":25,"offset":1483},"end":{"line":63,"column":35,"offset":1493},"indent":[]}},{"type":"text","value":" にマージする","position":{"start":{"line":63,"column":35,"offset":1493},"end":{"line":63,"column":42,"offset":1500},"indent":[]}}],"position":{"start":{"line":63,"column":4,"offset":1462},"end":{"line":63,"column":42,"offset":1500},"indent":[]}}],"position":{"start":{"line":63,"column":1,"offset":1459},"end":{"line":63,"column":42,"offset":1500},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"\bローカルにある ","position":{"start":{"line":64,"column":4,"offset":1504},"end":{"line":64,"column":13,"offset":1513},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":64,"column":13,"offset":1513},"end":{"line":64,"column":18,"offset":1518},"indent":[]}},{"type":"text","value":" を使って、ローカルの ","position":{"start":{"line":64,"column":18,"offset":1518},"end":{"line":64,"column":30,"offset":1530},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":64,"column":30,"offset":1530},"end":{"line":64,"column":40,"offset":1540},"indent":[]}},{"type":"text","value":" に対して ","position":{"start":{"line":64,"column":40,"offset":1540},"end":{"line":64,"column":46,"offset":1546},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">terraform plan</code>","position":{"start":{"line":64,"column":46,"offset":1546},"end":{"line":64,"column":62,"offset":1562},"indent":[]}},{"type":"text","value":" を行い、リソースの追加や削除といった変更が出ないことを確認する ( ","position":{"start":{"line":64,"column":62,"offset":1562},"end":{"line":64,"column":97,"offset":1597},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tf</code>","position":{"start":{"line":64,"column":97,"offset":1597},"end":{"line":64,"column":102,"offset":1602},"indent":[]}},{"type":"text","value":" の状態と ","position":{"start":{"line":64,"column":102,"offset":1602},"end":{"line":64,"column":108,"offset":1608},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":64,"column":108,"offset":1608},"end":{"line":64,"column":118,"offset":1618},"indent":[]}},{"type":"text","value":" に差分がないことを確認する)","position":{"start":{"line":64,"column":118,"offset":1618},"end":{"line":64,"column":133,"offset":1633},"indent":[]}}],"position":{"start":{"line":64,"column":4,"offset":1504},"end":{"line":64,"column":133,"offset":1633},"indent":[]}}],"position":{"start":{"line":64,"column":1,"offset":1501},"end":{"line":64,"column":133,"offset":1633},"indent":[]}},{"type":"listItem","loose":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"問題なければ、ローカルにコピーした ","position":{"start":{"line":65,"column":4,"offset":1637},"end":{"line":65,"column":22,"offset":1655},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">.tfstate</code>","position":{"start":{"line":65,"column":22,"offset":1655},"end":{"line":65,"column":32,"offset":1665},"indent":[]}},{"type":"text","value":" をリモートに上書き","position":{"start":{"line":65,"column":32,"offset":1665},"end":{"line":65,"column":42,"offset":1675},"indent":[]}}],"position":{"start":{"line":65,"column":4,"offset":1637},"end":{"line":65,"column":42,"offset":1675},"indent":[]}}],"position":{"start":{"line":65,"column":1,"offset":1634},"end":{"line":65,"column":42,"offset":1675},"indent":[]}}],"position":{"start":{"line":61,"column":1,"offset":1390},"end":{"line":65,"column":42,"offset":1675},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"となります。これをシェルで雑に書くとこんな処理になります。","position":{"start":{"line":67,"column":1,"offset":1677},"end":{"line":67,"column":30,"offset":1706},"indent":[]}}],"position":{"start":{"line":67,"column":1,"offset":1677},"end":{"line":67,"column":30,"offset":1706},"indent":[]}},{"type":"html","value":"<pre class=\"lang:shell decode:true\">\n#!/usr/bin/env bash\n# terraforming_merge.sh\n\nset -o nounset\nset -o errexit\n\nterraforming_resource_key=$1\noutput_filename=$2.tf\n\n# リモートから .tfstateをとってくる\naws s3 cp s3://my-terraform-state/aws-terraform.tfstate ./bin/\n\n# バックアップとっておく\ncp ./bin/aws-terraform.tfstate ./bin/aws-terraform.tfstate.bak\n\n# .tf に書き出し\nterraforming $terraforming_resource_key > $output_filename\n\n# tfstateにマージ\nterraforming $terraforming_resource_key --tfstate --merge ./bin/aws-terraform.tfstate --overwrite\n\n# 差分がでてないか確認。差分出たときのコメントをgrepしてるだけなので、仕様変更に要注意\n./bin/terraform_plan.sh > result.log\nis_changed=$(echo $(cat result.log | grep 'to add'))\n\nif [ -n \"$is_changed\" ]; then\n  # 差分が出てたら、result.logを見て修正する\n  echo \"diff found. Check your changes.\"\nelse\n  # 差分がなければimport成功\n  echo \"ALL GREEN. .bak is deleted and overwrite merged tfstate to s3.\"\n  rm ./bin/aws-terraform.tfstate.bak\n  rm result.log\n  # upload tfstate\n  aws s3 cp ./bin/aws-terraform.tfstate s3://my-terraform-state/aws-terraform.tfstate\n  rm ./bin/aws-terraform.tfstate\nfi\n</pre>","position":{"start":{"line":69,"column":1,"offset":1708},"end":{"line":107,"column":7,"offset":2760},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"呼び出すときは\n","position":{"start":{"line":109,"column":1,"offset":2762},"end":{"line":110,"column":1,"offset":2770},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ terraforming_merge.sh vpc my-vpc</code>","position":{"start":{"line":110,"column":1,"offset":2770},"end":{"line":110,"column":37,"offset":2806},"indent":[]}},{"type":"text","value":"\nみたいに使います。\nこのスクリプトで、リソースの種別ごとにまとめてimportできるようになりました。\n(もしこれを使うようでしたら、一応一行ずつ実行して問題ないか確認してくださいね！)","position":{"start":{"line":110,"column":37,"offset":2806},"end":{"line":113,"column":42,"offset":2900},"indent":[1,1,1]}}],"position":{"start":{"line":109,"column":1,"offset":2762},"end":{"line":113,"column":42,"offset":2900},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"完！と行きたいのですが、一つ問題が。\nterraformingでimportできるリソースの種類が非常に限られたものだけになっています。\n（本家の開発が早すぎるのでやむを得ないと思いますが。）","position":{"start":{"line":115,"column":1,"offset":2902},"end":{"line":117,"column":28,"offset":2998},"indent":[1,1]}}],"position":{"start":{"line":115,"column":1,"offset":2902},"end":{"line":117,"column":28,"offset":2998},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"とはいえ、\nVPC、Route53、Security Group、RDS、ELBなどの\nコアなものについてはカバーされていますので、ある程度はこれでimportできる気がします。","position":{"start":{"line":119,"column":1,"offset":3000},"end":{"line":121,"column":46,"offset":3089},"indent":[1,1]}}],"position":{"start":{"line":119,"column":1,"offset":3000},"end":{"line":121,"column":46,"offset":3089},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"これでimportできないものについては、\n最初に挙げた1や2の方法で少しずつTerraform化していくことになるのかなと。","position":{"start":{"line":123,"column":1,"offset":3091},"end":{"line":124,"column":42,"offset":3154},"indent":[1]}}],"position":{"start":{"line":123,"column":1,"offset":3091},"end":{"line":124,"column":42,"offset":3154},"indent":[1]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":124,"column":42,"offset":3154}}}}