{"expireTime":9007200845574950000,"key":"transformer-remark-markdown-html-ast-b9d9f9c4c808eb802ecea21259640f43-gatsby-plugin-sharpgatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-emojis-","val":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"またGKEネタです。","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":11,"offset":11}}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":11,"offset":11}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"kubernetes clientについて","position":{"start":{"line":4,"column":4,"offset":16},"end":{"line":4,"column":25,"offset":37}}}],"position":{"start":{"line":4,"column":1,"offset":13},"end":{"line":4,"column":25,"offset":37}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"kuberentesをプログラミング言語で操作するためのものです。普段 kubectl コマンドで操作している内容ですね。\nJS, Python, JavaはGAっぽくて、Golang, Haskell, RubyあたりはWIPのようです。\n","position":{"start":{"line":6,"column":1,"offset":39},"end":{"line":8,"column":1,"offset":160}}},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-client"},"children":[{"type":"text","value":"https://github.com/kubernetes-client","position":{"start":{"line":8,"column":2,"offset":161},"end":{"line":8,"column":38,"offset":197}}}],"position":{"start":{"line":8,"column":1,"offset":160},"end":{"line":8,"column":77,"offset":236}}},{"type":"text","value":"\n","position":{"start":{"line":8,"column":77,"offset":236},"end":{"line":9,"column":1,"offset":237}}},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-client/python"},"children":[{"type":"text","value":"Python製","position":{"start":{"line":9,"column":2,"offset":238},"end":{"line":9,"column":9,"offset":245}}}],"position":{"start":{"line":9,"column":1,"offset":237},"end":{"line":9,"column":55,"offset":291}}},{"type":"text","value":"が一番スター数が多く、そろそろ1000くらいですね。","position":{"start":{"line":9,"column":55,"offset":291},"end":{"line":9,"column":81,"offset":317}}}],"position":{"start":{"line":6,"column":1,"offset":39},"end":{"line":9,"column":81,"offset":317}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"しかしながら、このチュートリアルが、ローカルから叩く場合くらいしか考慮されてないため、本記事で説明します。","position":{"start":{"line":11,"column":1,"offset":319},"end":{"line":11,"column":54,"offset":372}}}],"position":{"start":{"line":11,"column":1,"offset":319},"end":{"line":11,"column":54,"offset":372}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"What to do","position":{"start":{"line":13,"column":4,"offset":377},"end":{"line":13,"column":14,"offset":387}}}],"position":{"start":{"line":13,"column":1,"offset":374},"end":{"line":13,"column":14,"offset":387}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"k8sクラスタのAPI serverのエンドポイントとCertificateを確認","position":{"start":{"line":15,"column":4,"offset":392},"end":{"line":15,"column":45,"offset":433}}}],"position":{"start":{"line":15,"column":1,"offset":389},"end":{"line":15,"column":45,"offset":433}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"k8sのservice accountを作成し、認証Tokenを確認","position":{"start":{"line":16,"column":4,"offset":437},"end":{"line":16,"column":38,"offset":471}}}],"position":{"start":{"line":16,"column":1,"offset":434},"end":{"line":16,"column":38,"offset":471}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Pythonコードからk8s APIを叩く","position":{"start":{"line":17,"column":4,"offset":475},"end":{"line":17,"column":25,"offset":496}}}],"position":{"start":{"line":17,"column":1,"offset":472},"end":{"line":17,"column":25,"offset":496}}},{"type":"text","value":"\n"}],"position":{"start":{"line":15,"column":1,"offset":389},"end":{"line":17,"column":25,"offset":496}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"1","position":{"start":{"line":19,"column":5,"offset":502},"end":{"line":19,"column":6,"offset":503}}},{"type":"text","value":".","position":{"start":{"line":19,"column":6,"offset":503},"end":{"line":19,"column":8,"offset":505}}},{"type":"text","value":" k8sクラスタのAPI serverのエンドポイントとCertificateを確認","position":{"start":{"line":19,"column":8,"offset":505},"end":{"line":19,"column":50,"offset":547}}}],"position":{"start":{"line":19,"column":1,"offset":498},"end":{"line":19,"column":50,"offset":547}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"最初完全に勘違いしていたんですが、GKE上にあるk8sクラスタへの接続にGCPのサービスアカウントなどは一切不要です。\nマスターノードやetcdには確かにアクセスできませんが、API serverにさえアクセスできれば操作はできます。\n","position":{"start":{"line":21,"column":1,"offset":549},"end":{"line":23,"column":1,"offset":667}}},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/"},"children":[{"type":"text","value":"そもそもAPI serverとの接続ってどうなってるのか","position":{"start":{"line":23,"column":2,"offset":668},"end":{"line":23,"column":30,"offset":696}}}],"position":{"start":{"line":23,"column":1,"offset":667},"end":{"line":23,"column":104,"offset":770}}},{"type":"text","value":" は説明があるので、一読しておくと良いです。","position":{"start":{"line":23,"column":104,"offset":770},"end":{"line":23,"column":126,"offset":792}}}],"position":{"start":{"line":21,"column":1,"offset":549},"end":{"line":23,"column":126,"offset":792}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"ということで、まずクラスタの認証情報などを確認します。\nいずれもGKEのコンソールから確認できます。","position":{"start":{"line":25,"column":1,"offset":794},"end":{"line":26,"column":23,"offset":844}}},{"type":"element","tagName":"a","properties":{"href":"https://qiita.com/zaru/items/bf5b4e60ad4d67be8bea"},"children":[{"type":"text","value":"この記事のスクリーンショット","position":{"start":{"line":26,"column":24,"offset":845},"end":{"line":26,"column":38,"offset":859}}}],"position":{"start":{"line":26,"column":23,"offset":844},"end":{"line":26,"column":90,"offset":911}}},{"type":"text","value":"がわかりやすいです。","position":{"start":{"line":26,"column":90,"offset":911},"end":{"line":26,"column":100,"offset":921}}}],"position":{"start":{"line":25,"column":1,"offset":794},"end":{"line":26,"column":100,"offset":921}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"2","position":{"start":{"line":28,"column":5,"offset":927},"end":{"line":28,"column":6,"offset":928}}},{"type":"text","value":".","position":{"start":{"line":28,"column":6,"offset":928},"end":{"line":28,"column":8,"offset":930}}},{"type":"text","value":" k8sのservice accountを作成し、認証Tokenを確認","position":{"start":{"line":28,"column":8,"offset":930},"end":{"line":28,"column":43,"offset":965}}}],"position":{"start":{"line":28,"column":1,"offset":923},"end":{"line":28,"column":43,"offset":965}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/access-authn-authz/authentication/"},"children":[{"type":"text","value":"認証方式は複数ある","position":{"start":{"line":30,"column":2,"offset":968},"end":{"line":30,"column":11,"offset":977}}}],"position":{"start":{"line":30,"column":1,"offset":967},"end":{"line":30,"column":85,"offset":1051}}},{"type":"text","value":"のですが、手っ取り早いものを採用します。","position":{"start":{"line":30,"column":85,"offset":1051},"end":{"line":30,"column":105,"offset":1071}}}],"position":{"start":{"line":30,"column":1,"offset":967},"end":{"line":30,"column":105,"offset":1071}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"k8sの内部にはservice accountというGCPのそれと似た概念があるのですが、このアカウントに適切な権限を付与して利用します。","position":{"start":{"line":32,"column":1,"offset":1073},"end":{"line":32,"column":70,"offset":1142}}}],"position":{"start":{"line":32,"column":1,"offset":1073},"end":{"line":32,"column":70,"offset":1142}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ServiceAccount: アカウント","position":{"start":{"line":34,"column":3,"offset":1146},"end":{"line":34,"column":24,"offset":1167}}}],"position":{"start":{"line":34,"column":1,"offset":1144},"end":{"line":34,"column":24,"offset":1167}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Role: 権限の定義","position":{"start":{"line":35,"column":3,"offset":1170},"end":{"line":35,"column":14,"offset":1181}}}],"position":{"start":{"line":35,"column":1,"offset":1168},"end":{"line":35,"column":14,"offset":1181}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"RoleBinding: Roleをアカウントに紐付けるという宣言","position":{"start":{"line":36,"column":3,"offset":1184},"end":{"line":36,"column":36,"offset":1217}}}],"position":{"start":{"line":36,"column":1,"offset":1182},"end":{"line":36,"column":36,"offset":1217}}},{"type":"text","value":"\n"}],"position":{"start":{"line":34,"column":1,"offset":1144},"end":{"line":36,"column":36,"offset":1217}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"この3つを作成して、権限を持ったアカウントを作成することができます。\nもしクラスタ全体にまたがった操作をする場合（ノードの状態を見る、クラスタ内の全podを確認するなど）は、","position":{"start":{"line":38,"column":1,"offset":1219},"end":{"line":39,"column":53,"offset":1306}}}],"position":{"start":{"line":38,"column":1,"offset":1219},"end":{"line":39,"column":53,"offset":1306}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ClusterRole: クラスタ全体に関わる権限の定義","position":{"start":{"line":41,"column":3,"offset":1310},"end":{"line":41,"column":31,"offset":1338}}}],"position":{"start":{"line":41,"column":1,"offset":1308},"end":{"line":41,"column":31,"offset":1338}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ClusterRoleBinding: ClusterRoleをアカウントに紐付けるという宣言","position":{"start":{"line":42,"column":3,"offset":1341},"end":{"line":42,"column":50,"offset":1388}}}],"position":{"start":{"line":42,"column":1,"offset":1339},"end":{"line":42,"column":50,"offset":1388}}},{"type":"text","value":"\n"}],"position":{"start":{"line":41,"column":1,"offset":1308},"end":{"line":42,"column":50,"offset":1388}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"が別に存在します。\n複数のnamespaceが存在する場合は、互いの誤干渉を防ぐため、できるだけnamespaceに閉じた権限を発行するのがよいでしょう。","position":{"start":{"line":44,"column":1,"offset":1390},"end":{"line":45,"column":68,"offset":1467}}}],"position":{"start":{"line":44,"column":1,"offset":1390},"end":{"line":45,"column":68,"offset":1467}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/access-authn-authz/rbac/"},"children":[{"type":"text","value":"公式を参考","position":{"start":{"line":47,"column":2,"offset":1470},"end":{"line":47,"column":7,"offset":1475}}}],"position":{"start":{"line":47,"column":1,"offset":1469},"end":{"line":47,"column":71,"offset":1539}}},{"type":"text","value":"に、こんな感じで発行できます。","position":{"start":{"line":47,"column":71,"offset":1539},"end":{"line":47,"column":86,"offset":1554}}}],"position":{"start":{"line":47,"column":1,"offset":1469},"end":{"line":47,"column":86,"offset":1554}}},{"type":"text","value":"\n"},{"type":"raw","value":"<pre class=\"lang:yaml decode:true \">apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: my-k8s-client\n  namespace: my-k8s-ns\nrules:\n- apiGroups: [“”] # “” indicates the core API group\n  resources: [“pods”, “services”]\n  verbs: [“get”, “list”, “watch”, “create”, “update”, “patch”, “delete”]\n- apiGroups: [“extensions”]\n  resources: [“deployments”]\n  verbs: [“get”, “list”, “watch”, “create”, “update”, “patch”, “delete”]\n- apiGroups: [“autoscaling”]\n  resources: [“horizontalpodautoscalers”]\n  verbs: [“get”, “list”, “watch”, “create”, “update”, “patch”, “delete”]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: my-k8s-client\n  namespace: my-k8s-ns\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: my-k8s-client\nsubjects:\n  - kind: ServiceAccount\n    name: my-k8s-client\n    namespace: my-k8s-ns\n</pre>","position":{"start":{"line":49,"column":1,"offset":1556},"end":{"line":78,"column":7,"offset":2429}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Roleだけちょっと面倒なんですが、Resourceが操作したい対象、apiGroupsがそれを操作できるAPIのカテゴリ（documentをめっちゃ見る）、verbsが許可する操作内容です。","position":{"start":{"line":80,"column":1,"offset":2431},"end":{"line":80,"column":97,"offset":2527}}}],"position":{"start":{"line":80,"column":1,"offset":2431},"end":{"line":80,"column":97,"offset":2527}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"これを ","position":{"start":{"line":82,"column":1,"offset":2529},"end":{"line":82,"column":5,"offset":2533}}},{"type":"raw","value":"<code class=\"language-text\">kubectl apply</code>","position":{"start":{"line":82,"column":5,"offset":2533},"end":{"line":82,"column":20,"offset":2548}}},{"type":"text","value":" してservice accountが作成できたら、","position":{"start":{"line":82,"column":20,"offset":2548},"end":{"line":82,"column":46,"offset":2574}}}],"position":{"start":{"line":82,"column":1,"offset":2529},"end":{"line":82,"column":46,"offset":2574}}},{"type":"text","value":"\n"},{"type":"raw","value":"<pre class=\"lang:shell decode:true \">kubectl get secrets --namespace=<namespace_name>kubectl describe secret/</namespace_name></pre>","position":{"start":{"line":84,"column":1,"offset":2576},"end":{"line":84,"column":133,"offset":2708}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"で、デプロイしたservice accountのTokenを取得します。","position":{"start":{"line":86,"column":1,"offset":2710},"end":{"line":86,"column":37,"offset":2746}}},{"type":"raw","value":"<code class=\"language-text\">ey~~~</code>","position":{"start":{"line":86,"column":37,"offset":2746},"end":{"line":86,"column":44,"offset":2753}}},{"type":"text","value":" の長い一行の文字列です。","position":{"start":{"line":86,"column":44,"offset":2753},"end":{"line":86,"column":57,"offset":2766}}}],"position":{"start":{"line":86,"column":1,"offset":2710},"end":{"line":86,"column":57,"offset":2766}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"3","position":{"start":{"line":88,"column":5,"offset":2772},"end":{"line":88,"column":6,"offset":2773}}},{"type":"text","value":".","position":{"start":{"line":88,"column":6,"offset":2773},"end":{"line":88,"column":8,"offset":2775}}},{"type":"text","value":" Pythonコードからk8s APIを叩く","position":{"start":{"line":88,"column":8,"offset":2775},"end":{"line":88,"column":30,"offset":2797}}}],"position":{"start":{"line":88,"column":1,"offset":2768},"end":{"line":88,"column":30,"offset":2797}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"準備が全て終わったので、実際にAPIを叩いてみましょう。","position":{"start":{"line":90,"column":1,"offset":2799},"end":{"line":90,"column":29,"offset":2827}}}],"position":{"start":{"line":90,"column":1,"offset":2799},"end":{"line":90,"column":29,"offset":2827}}},{"type":"text","value":"\n"},{"type":"raw","value":"<pre class=\"lang:python decode:true \">from kubernetes import client\nimport yaml\n\n# init\nconfiguration = client.Configuration()\n\n# step2で取得したTokenを記述\nconfiguration.api_key[\"authorization\"] = '<bearer_token>' configuration.api_key_prefix['authorization'] = 'Bearer' # step1で取得したAPI serverのエンドポイント configuration.host = 'https://<ip_of_api_server>' # step1で取得したAPI serverのCertificate。文字列では渡せなさそう configuration.ssl_ca_cert = '<path_to_cluster_ca_certificate>' # api叩くインスタンス生成 v1 = client.CoreV1Api(client.ApiClient(configuration)) # とりあえずpodを見てみる print(v1.list_namespaced_pod(namespace=my-k8s-ns)) # デプロイするときは別のapiインスタンス。まだbetaを使っている deploy_api = client.ExtensionsV1beta1Api(client.ApiClient(configuration)) # 定義したyamlを使ってdeploymentを作成 with open('path/to/deployment.yaml') as f: nice_dict = yaml.load(f) resp = deploy_api.create_namespaced_deployment(body=nice_dict, namespace=my-k8s-ns)</path_to_cluster_ca_certificate></ip_of_api_server></bearer_token></pre>","position":{"start":{"line":92,"column":1,"offset":2829},"end":{"line":99,"column":807,"offset":3784}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"pseudo codeですが、だいたいこんなので動作します。\n","position":{"start":{"line":101,"column":1,"offset":3786},"end":{"line":102,"column":1,"offset":3817}}},{"type":"raw","value":"<code class=\"language-text\">kubectl apply</code>","position":{"start":{"line":102,"column":1,"offset":3817},"end":{"line":102,"column":16,"offset":3832}}},{"type":"text","value":" 相当の処理が必要な場合は、","position":{"start":{"line":102,"column":16,"offset":3832},"end":{"line":102,"column":30,"offset":3846}}},{"type":"raw","value":"<code class=\"language-text\">deploy_api.patch_namespaced_deployment</code>","position":{"start":{"line":102,"column":30,"offset":3846},"end":{"line":102,"column":70,"offset":3886}}},{"type":"text","value":" を使って try-exceptして実装します。","position":{"start":{"line":102,"column":70,"offset":3886},"end":{"line":102,"column":94,"offset":3910}}}],"position":{"start":{"line":101,"column":1,"offset":3786},"end":{"line":102,"column":94,"offset":3910}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Basic認証などもありますが、チュートリアルには説明がないので","position":{"start":{"line":104,"column":1,"offset":3912},"end":{"line":104,"column":33,"offset":3944}}},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-client/python/blob/master/kubernetes/client/configuration.py#L84"},"children":[{"type":"text","value":"実装を見ながら","position":{"start":{"line":104,"column":34,"offset":3945},"end":{"line":104,"column":41,"offset":3952}}}],"position":{"start":{"line":104,"column":33,"offset":3944},"end":{"line":104,"column":138,"offset":4049}}},{"type":"text","value":"頑張る感じになります。","position":{"start":{"line":104,"column":138,"offset":4049},"end":{"line":104,"column":149,"offset":4060}}}],"position":{"start":{"line":104,"column":1,"offset":3912},"end":{"line":104,"column":149,"offset":4060}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"チュートリアルの多くは","position":{"start":{"line":106,"column":1,"offset":4062},"end":{"line":106,"column":12,"offset":4073}}},{"type":"raw","value":"<code class=\"language-text\">config.load_kube_config()</code>","position":{"start":{"line":106,"column":12,"offset":4073},"end":{"line":106,"column":39,"offset":4100}}},{"type":"text","value":" を使えばokと結論づけているのですが、\nprogramaticにアクセスするときにはやはり上記の手順を踏むべきかなと思いました。","position":{"start":{"line":106,"column":39,"offset":4100},"end":{"line":107,"column":45,"offset":4165}}}],"position":{"start":{"line":106,"column":1,"offset":4062},"end":{"line":107,"column":45,"offset":4165}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"なお、今回の記事は\n","position":{"start":{"line":109,"column":1,"offset":4167},"end":{"line":110,"column":1,"offset":4177}}},{"type":"element","tagName":"a","properties":{"href":"https://stackoverflow.com/questions/48151388/kubernetes-python-client-authentication-issue"},"children":[{"type":"text","value":"stackoverflowの投稿","position":{"start":{"line":110,"column":2,"offset":4178},"end":{"line":110,"column":18,"offset":4194}}}],"position":{"start":{"line":110,"column":1,"offset":4177},"end":{"line":110,"column":111,"offset":4287}}},{"type":"text","value":"を参考に補足などしたものです。\n大変助かりました。","position":{"start":{"line":110,"column":111,"offset":4287},"end":{"line":111,"column":10,"offset":4312}}}],"position":{"start":{"line":109,"column":1,"offset":4167},"end":{"line":111,"column":10,"offset":4312}}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":111,"column":10,"offset":4312}}}}